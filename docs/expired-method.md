# Работа с экспирированными опционами в ETH Options Dashboard

Документ фиксирует, как система обращается с ногами и позициями, у которых завершился срок действия (delivery time). Ниже — полный жизненный цикл и все автоматизации, которые сейчас реализованы.

## 1. Детекция экспирации

- Каждый позиционный объект (`Row`) анализируется на предмет истёкших опционных ног — ног, у которых `expiryMs > 0` и `expiryMs ≤ Date.now()`.
- Для удобства UI мы считаем агрегированный статус через `describeExpiry`:
  - `active` — у позиции нет истёкших ног.
  - `partial` — часть ног истекла, часть ещё впереди.
  - `expired` — все опционные ноги истекли (либо позиция состоит только из ног с прошедшей датой).
- Одновременно вычисляется флаг `unsettled`, если хотя бы у одной истёкшей ноги отсутствует зафиксированное settlement-значение.

## 2. Автоматический settlement

- Периодический эффект (раз в 60 секунд) и немедленно при изменении стора запускают функцию `runAutoSettle()`:
  1. Собираем истёкшие ноги, у которых ещё нет сохранённого settlement.
  2. Для каждой уникальной комбинации позиция/expiry пробуем получить биржевой delivery price.
     - Основной запрос: `GET /v5/market/delivery-price?category=option&symbol=…`.
     - Резервный запрос (если по `symbol` отвечает пусто): `GET /v5/market/delivery-history?category=option&baseCoin=…&settleCoin=…` с фильтрацией по символу.
     - Ответ кэшируется на 12 часов; неуспешные попытки повторяются через 5 минут.
  3. Если получено положительное число — вызываем `setSpreadSettlement` или `setPositionSettlement`. Settlement сохраняется на уровне стора, PnL фиксируется, Greeks обнуляются.

### Обработка ошибок

- Если API отвечает 404 или другим кодом — логируем через `console.warn`, повторяем попытку позже.
- Модуль сервиса обёрнут в `try/catch`, поэтому отсутствие данных не ломает приложение.

## 3. Автозакрытие позиции

- После загрузки settlement автоэффект проверяет: если **все** опционные ноги позиции имеют `expiryMs ≤ now`, она переводится в статус закрытой (`markClosed` для спредов или `closePosition` для мульти‐legs). Пользователь не обязан вручную нажимать “Close”.
- Ноги со “вневременными” символами (SPOT/PERP) игнорируются: при наличии PERP/hedge позиция может остаться открытой.

## 4. Ручная модалка “Settle”

- Кнопка `Settle` остаётся, но теперь это скорее ручная страховка:
  - Модалка показывает список истёкших экспираций, уточняет settlement для каждой.
  - Сразу при открытии пытается подтянуть биржевую цену (используется тот же сервис API). Если нашлась — поле автозаполняется и подсказка помечается `(Bybit)`.
  - Пользователь может сохранить введённое значение или очистить settlement (оставить поле пустым → система удалит сохранённое).
  - Раньше был чекбокс “Отметить позицию закрытой”; после внедрения авто‐закрытия он удалён.

## 5. UI / фидбек

- Статусы позиционируются на бейджах: `expired`, `partial exp`, `unsettled`. Это облегчает визуальную сортировку.
- В таблице видно settlement‐подсказки, PnL фиксируется под “Сеттлевой” ценой — позиция больше не “плавает”.
- Настройка “Hide expired” по умолчанию активна, так что исторические позиции скрываются из списка. Фильтр можно отключить.

## 6. Persist и экстенсивность

- Все новые данные (settlements, экшены, настройки) хранятся в локальном `localStorage`: `options-dashboard` (через Zustand persist) + отдельные ключи `positions-actions-v1`, `positions-columns-v1`, `positions-ui-v1`.
- Структуры `settlements` присутствуют и у спредов, и у мульти‐legs, и в persistence‐импорте. Это позволяет безболезненно импортировать/экспортировать историю.

## 7. Открытые вопросы / TODO (по желанию)

- Прямо сейчас мы не фиксируем «официальный settlement timestamp»/mark; при необходимости можно сохранять поле `settledAt` (оно уже есть в типе `PositionLeg`).
- При желании можно расширить API: например, поддержать автоматическое “пробрасывание” delivery price при добавлении позиции (из истории) — сейчас логика работает уже после того, как позиция живёт в сторе.
- Можно добавить уведомления/тостер, если auto‐settle не сработал (необязательно).

В текущей конфигурации большинство ручной работы исчезает: система сама фиксирует settlement, сама закрывает позицию. Ручная модалка остаётся на случай, если биржа не отдала цену (или пользователь хочет указать свою цифру).
