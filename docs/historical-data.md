# Исторические данные по опционам Bybit — подробный обзор и выводы

Документ консолидирует всё обсуждение по историческим данным, их источникам, ограничениям и практическим подходам к бэктестам опционных стратегий на Bybit (USDT‑settled ETH options).

## 1) Контекст проекта и текущие данные
- Реалтайм-источники в коде:
  - REST `src/services/bybit.ts`: инструменты (`/v5/market/instruments-info`), опционные тикеры (`/v5/market/tickers?category=option`), L1‑снимок стакана (`/v5/market/orderbook`), спот ETH, HV30.
  - WebSocket `src/services/ws.ts`: подписки на `tickers.{symbol}` и `orderbook.1.{symbol}` из `wss://stream.bybit.com/v5/public/option` и `.../spot`.
- Нормализация/фильтры:
  - Используем только USDT‑settled опционы (фильтры по `settleCoin=USDT`/`quoteCoin=USDT`, `baseCoin=ETH`).
  - `midPrice(t)` считается как среднее между валидными bid/ask (из OB или тикера) с fallback на `markPrice`.

## 2) Что считается «историческими данными» и чем они покрываются
- Инструменты (instruments-info): метаданные (страйк, тип, экспирация). История здесь не критична; достаточно актуального REST.
- Тикеры (options): моментальные срезы — bid/ask/mark, greeks (Δ/Γ/ν/Θ), OI, last. Исторический аналог — архивы Data Center `option/tickers` (минутные снимки L1 и ключевых метрик).
- Стакан L1/L50/200: реалтайм через REST/WS (`orderbook.*`). Исторического архива стаканов на Data Center нет.
- Свечи/ряды цен: `kline`, `mark-price-kline`, `index-price-kline` — исторические ряды по опционным символам/индексу/mark price.
- Волатильность: `historical-volatility` и `iv` — исторические HV/IV (без стакана).

Итого: почти все «тикерные» поля имеют историческую замену в Data Center, кроме собственной истории стакана (глубины/объёмов по уровням и тиковых L1‑снимков).

## 3) Bybit Data Center (официальный bulk)
- Портал: https://www.bybit.com/en-US/data, CDN: `https://public.bybit.com/option/`.
- Типичные наборы для опционов: `tickers/`, `kline/`, `markPriceKline/`, `indexPriceKline/`, `iv/`, `openInterest/`, `trades/`.
- `option/tickers`: минутные снимки L1 для каждого символа — есть `bidPrice`, `askPrice`, `markPrice`, greeks, OI, иногда объёмы и last. «Исторический mid» восстанавливается как `(bidPrice + askPrice)/2`.
- Ограничения: нет истории глубины (L2/L50/200), нет объёмов по сторонам книги; данные агрегированы по минутам (не тик‑за‑тик).

## 4) Публичный REST (история) — что и как тянуть
- Свечи цены по опциону: `GET /v5/market/kline?category=option&symbol=ETH-YYYYMMDD-STRIKE-{C|P}-USDT&interval=...&start=...&end=...&limit=1000` (пагинация через `nextPageCursor`).
- Mark/Index ряды: `GET /v5/market/mark-price-kline`, `GET /v5/market/index-price-kline` с теми же параметрами категории/символа.
- Волатильность: `GET /v5/market/historical-volatility` (HV) и `GET /v5/market/iv` (IV) для опционов.
- Пределы: за один вызов до 1000 точек, для длинной истории — цикл с курсором/окнами времени.
- Веб‑сокеты: дают realtime, но не исторические данные; для истории — собственный логгер или Data Center.

## 5) Символы и фильтры (USDT‑settled ETH options)
- Формат опционного символа: `ETH-YYYYMMDD-STRIKE-C|P-USDT`.
- В проекте фильтруем по `baseCoin=ETH` и нормализуем `settleCoin/quoteCoin` до `USDT`.
- Для исторических CSV тоже важно фильтровать только `...-USDT`.

## 6) Mid и другие производные метрики (как восстанавливать из истории)
- Mid: `(bid + ask) / 2`. Если какой‑то из спотов отсутствует — использовать доступный; при отсутствии обоих — fallback на `markPrice`.
- Спрэд: `ask − bid`, относительный спрэд: `(ask − bid) / mid`.
- Цена спреда (vertical PUT): `mid(short) − mid(long)`.
- PnL (per leg): `sgn × (entry − mid) × qty` (sgn: +1 short, −1 long). Net по позиции — сумма по ногам.
- Ликвидность (приближение): минимальный OI по ногам; относительный спрэд по ногам; можно ввести пороговые фильтры.

## 7) Что недоступно исторически и чем заменять
- Нет: истории стакана (ни L1‑тик‑за‑тик, ни глубины/объёмов). Data Center не хранит order book.
- Частичная замена: минутные `tickers` содержат L1 bid/ask → можно восстановить «минутный mid»/спрэд, но без внутриминутной динамики и объёмов.
- Полная замена: сторонние провайдеры (Kaiko, Amberdata, CCData/CryptoCompare, CoinAPI и др.) или собственная запись WS потока вперёд.

## 8) Бэктесты: когда минутных данных достаточно
- «Медленные» стратегии (подбор страйков/экспираций, управление греческими, дневные/часовые решения) — минутные `tickers`+`iv`+`markPriceKline` обычно достаточно.
- Для кредитных/вертикальных спредов без точного стакана нужно вводить допущения по исполнению:
  - Модель проскальзывания: фиксированная абсолютная величина, доля от mid, либо доля от текущего спрэда.
  - Фильтры ликвидности: минимальный OI, максимальный относительный спрэд, минимальная частота ненулевых bid/ask.
  - Консервативное правило выполнения: для продажи — ближе к bid; для покупки — ближе к ask; mid допускается только с надбавкой/скидкой.
- Ограничения: внутриминутные «разъезды» спрэда, всплески и отсутствие объёма останутся невидимыми → результаты могут быть оптимистичны.

## 9) Бэктесты: когда история L1/L2 критична
- Тактики на узком спрэде/арбитраже, внутридневные быстродействующие стратегии, точная оценка вероятности исполнения legs — без тикового L1/L2 история критична.
- Для точного моделирования входов/выходов по bid/ask и оценки latency‑risk потребуется:
  - Сбор тиков L1/L50/200 из WS и долговременное хранение;
  - Либо коммерческие исторические наборы от провайдеров.

## 10) Практические рецепты
- План загрузки истории через REST:
  1) Сформировать список символов (по REST `instruments-info`, отфильтровать `...-USDT`).
  2) Для каждого символа: бежать окнами по времени с `kline/mark-price-kline/index-price-kline/iv` (до 1000 точек на вызов), сохранять в локальное хранилище.
  3) Для минутного mid использовать архив `option/tickers` с Data Center: для каждой строки вычислить mid и спрэд.
  4) Нормализовать таймзоны/метки времени и синхронизировать ряды (resample до единой сетки минут).
- Интеграция в проект:
  - Добавить исторический загрузчик/кешер в слой данных;
  - Параметры: диапазон дат, набор метрик (mid/mark/iv/oi), правила иммутации пропусков и модель проскальзывания.

## 11) Выводы (сжатые)
- Да, исторические данные по большинству используемых нами метрик есть: в Data Center можно взять минутные `tickers` (bid/ask/mark/greeks/OI), а также ряды `kline`, `markPriceKline`, `indexPriceKline`, `iv`.
- История стакана (глубина/объёмы, тик‑за‑тик L1) у Bybit отсутствует в публичных архивах; её надо логировать самим или покупать.
- Для «медленных» опционных стратегий минутных данных обычно хватает; для точного моделирования исполнения по спредам потребуется модель слippage и/или детальный order book.

## 12) Ссылки и ориентиры
- Реалтайм в коде: `src/services/bybit.ts`, `src/services/ws.ts`.
- Data Center: `https://public.bybit.com/option/` (архивы); портал описаний — `https://www.bybit.com/en-US/data`.
- Публичный REST v5: категория `option`, лимит 1000, курсорная пагинация, параметры символа/монет (`settleCoin=USDT`, `quoteCoin=USDT`, `baseCoin=ETH`).
