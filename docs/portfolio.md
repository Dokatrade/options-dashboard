# Portfolio — концепция обновления

## Общая идея
- Перевести раздел в режим "портфель как дашборд": агрегаты по рискам, греклам, P/L, марже.
- Сделать интерактивные ссылки на Options Dashboard для каждого тикера/стратегии.
- Ввести индикаторы состояния (лимиты, концентрация, сроки) с подсказками и действиями.
- Расширить таблицу позиций: группировка по стратегиям, break-even, expirations, быстрый переход в детализацию.
- Добавить мини-сценарный анализ (слайдеры цены/IV) с пересчетом агрегированных показателей портфеля.
- Вынести инструменты (backup, пресеты фильтров, экспорт) в отдельный блок Portfolio Tools.

## План реализации
1. **Прояснить требования**: список KPI, сценарии перехода, критерии сигналов, связи с текущими данными Dashboard.
2. **Проектирование UX/UI**: вайрфрейм нового Portfolio (агрегаты, Alerts, таблица, фильтры, tools), согласование навигации.
3. **Работа со стором**: расширить типы и селекторы (греки, маржа, P/L, alerts), настроить синхронизацию фильтров с Dashboard.
4. **Базовые компоненты**: декомпозировать `PortfolioSummary` на `PortfolioStats`, `PortfolioAlerts`, `PortfolioTable`, `PortfolioTools` и связать со стором.
5. **Интеграция с Options Dashboard**: маршруты и линкование, общие фильтры и пресеты.
6. **Сценарный анализ**: контролы чувствительности (цена, волатильность), кеширование результатов.
7. **Таблица позиций**: группировка по стратегиям, расчеты break-even, сортировки, подсветка критичных позиций.
8. **Alerts & Health**: правила на лимиты, концентрацию и expirations, визуальные статусы, подсказки.
9. **Portfolio Tools**: backup/export, пресеты фильтров, CSV/PDF, обновление справки.
10. **Валидация**: тесты селекторов и сигналов, ручная проверка сценариев, документация и чек-лист регрессии.

## Детализированный backlog
### Data & Store
- Собрать полный список полей из `src/store/store.ts`, `src/utils/types.ts`, выяснить, какие данные доступны от Options Dashboard (через сервисы или API).
- Добавить в типы `PortfolioSettings` новые параметры: лимиты по грейкам, максимальный размер позиции на тикер, настройки сигналов.
- Реализовать агрегирующие селекторы: суммарные греки (Delta, Gamma, Theta, Vega) по портфелю/тикеру/стратегии; маржинальные требования; MaxLoss/MaxGain; реализованный и нереализованный P/L.
- Настроить селектор концентрации (доля по тикеру и по стратегии) с порогами для сигналов.
- Обновить импорт/экспорт JSON (DataBackup) для сохранения новых полей и пресетов фильтров.

### Components & UI
- Разбить `PortfolioSummary` на подкомпоненты: `PortfolioStats` (агрегаты), `PortfolioAlerts` (индикаторы), `PortfolioScenario` (контролы чувствительности), `PortfolioTable` (позиции), `PortfolioTools`.
- Подготовить UI-компоненты для отображения KPI: карточки со значениями, мини-чарты для P/L и экспозиций, индикаторы состояния (иконки, цветовые статусы).
- Реализовать таблицу с поддержкой группировки по стратегии/тикеру, сортировок, раскрытия деталей и кнопки "Открыть в Dashboard".
- Добавить контролы фильтров: выбор символов, типов стратегий, диапазона expiration; двойная синхронизация с Dashboard.
- Реализовать сценарный блок: слайдер цены базового актива, шаги IV; отображать пересчитанные агрегаты и изменения в процентах.

### Alerts & Health
- Определить правила сигналов: превышение MaxLoss/Deposit, концентрация > X%, отсутствие хеджей, позиции с экспирацией < N дней.
- Настроить отображение карточек-сигналов: уровень (info/warn/critical), текст подсказки, CTA (перейти в Dashboard, закрыть позицию, увеличить депозит).
- Учесть режим "без сигналов" при отсутствии данных или если пользователь отключил уведомления.

### Integration & Navigation
- Настроить общий объект фильтров (Context или Zustand store) для Portfolio и Dashboard, с сохранением пресетов.
- Обновить роутинг/линки: переходы из таблицы и карточек к нужным состояниям Dashboard с передачей фильтров.
- Рассмотреть обратные переходы (из Dashboard в Portfolio) для возврата к сводке с теми же фильтрами.

### Documentation & Support
- Расширить `HelpModal` и `docs/` описанием новых возможностей портфеля и сигналов.
- Подготовить раздел FAQ по сценарному анализу и сохранению пресетов.

## Стартовые шаги
- Провести ревью стора (`src/store/store.ts`) и утилит; составить таблицу текущих метрик vs необходимых.
- Подготовить быстрый макет (sketch/figma) с расположением агрегатов, Alerts, таблицы и переходов.
- После согласования макета сформировать backlog задач по данным, компонентам и интеграции Dashboard с оценками.

## Черновой вайрфрейм (текстовое описание)
- **Шапка**: название Portfolio, текущая дата/время, кнопка быстрого экспорта.
- **Блок KPI (в 2 строки)**: карточки Delta/Gamma/Theta/Vega, MaxLoss/MaxGain, Margin Impact, P/L (дневной и общий). Цветовое кодирование состояний.
- **Alerts & Health**: горизонтальная лента карточек-сигналов; клик открывает popover с действиями.
- **Scenario Controls**: небольшая панель с слайдерами цены (+/- %), волатильности (IV shift), чекбоксами режима (spot/expiration). Ниже показываем дельту изменений по ключевым метрикам.
- **Фильтры**: символы, стратегии, expiration range, чекбокс "только открытые"; сохраняемые пресеты (dropdown).
- **Таблица позиций**: слева — сгруппированный список (тикер > стратегия > позиция), справа — ключевые метрики (Qty, Entry, Mid, P/L, BreakEven, Expiration, Risk). В строках иконка для перехода в Dashboard.
- **Portfolio Tools**: блок внизу с кнопками Export/Import, Manage Presets, Download CSV/PDF, ссылка на документацию.
- **Доп. информация**: заметки пользователя или checklist по управлению портфелем.

## Зависимости и риски
- Требуется подтверждение доступности данных для расчета греков и маржи; если их нет, нужна интеграция с источником.
- Производительность: пересчет агрегатов и сценариев может быть тяжелым; нужен план по мемоизации и lazy-loading.
- UX-риски: переизбыток информации; необходимо тестирование прототипа с реальными пользователями/кейсами.

## Многопортфельная архитектура — roadmap

### Цели и ограничения
- Поддержать одновременное существование нескольких независимых портфелей (разные стратегии/сеты сделок) без пересечения данных.
- Обеспечить бесшовную миграцию текущего единственного портфеля в формат "один из N" без потери истории и настроек.
- Сохранить производительность: переключение портфеля должно занимать O(число позиций портфеля), а фоновые расчёты — не блокировать UI других портфелей.
- Минимизировать изменения API/экспортов: пользовательские бэкапы и интеграции должны продолжить работать через адаптеры.

### Фаза 0 — исследование и дизайн
1. **Картографировать текущее использование стор-модели**: `PortfolioSummary`, `UnifiedPositionsTable`, `SpreadTable`, `TopBarBackupButtons`, модалки View/Edit/Import/Export.
2. **Выделить пересечения с Dashboard**: где портфельные данные читаются вне `/Portfolio` (например, HelpModal, SlowMode controller).
3. **Прописать требования к UX**: сценарии создания/удаления/клонирования, поведение фильтров и хранения локальных настроек (columns, view preferences) на портфель.
4. **Согласовать навигационный паттерн**: dropdown в top-bar, левое меню, hotkeys.

### Фаза 1 — модель данных
1. **Новые типы**
   - `PortfolioId = string`.
   - `PortfolioMeta { id: PortfolioId; name: string; note?: string; createdAt: number; updatedAt: number; }`.
   - `PortfolioBundle { meta: PortfolioMeta; spreads: SpreadPosition[]; positions: Position[]; settings: PortfolioSettings; }`.
2. **Рефактор стора**
   - Хранить `{ activePortfolioId, portfolios: Record<PortfolioId, PortfolioBundle> }`.
   - Обновить действия: `createPortfolio`, `renamePortfolio`, `clonePortfolio`, `deletePortfolio`, `setActivePortfolio`, `updatePortfolioSettings`, `addSpread(portfolioId, …)` и т.д.
   - Обеспечить неизменность старых сигнатур (для компонентов) через thin-шлюз `useActivePortfolio()`.
3. **Миграция persist**
   - Версия `persist`++: при загрузке legacy-формата `spreads/positions/settings` оборачивать в дефолтный портфель `Default Portfolio`.
   - Специальные маркеры для single→multi перехода, чтобы не повторять миграцию.
4. **Селекторы**
   - Все вычисляемые функции (агрегаты, фильтры) принимают `portfolioId` или работают через активный.
   - Для глобальных фич (например, SlowMode) предусмотреть карту подписок по портфелю.

### Фаза 2 — API слоя и побочный код
1. **Backup/Import**
   - JSON-структура: `{ portfolios: PortfolioBundleExport[], activePortfolioId }`.
   - Поддержка импорта одно- и многопортфельных файлов (предложить пользователю: импортировать всё, выбрать конкретный).
2. **Экспорт CSV/PDF**
   - Добавить поле `portfolioName` в заголовки.
3. **LocalStorage ключи**
   - Нормализовать ключи вида `positions-ui-v1::<portfolioId>` для колонок, slow-mode prefs, view-state.
4. **Background tasks**
   - SlowMode / WS подписки должны уметь быстро пересоздаваться при смене портфеля.
   - Рассмотреть lazy-инициализацию данных "по требованию", чтобы не грузить греческие данные для всех портфелей сразу.

### Фаза 3 — UI и навигация
1. **Switch UI**
   - Dropdown/command palette в топе с поиском, индикацией активного портфеля и CTA "Create".
   - Диалоги: создание (имя, опциональная иконка/цвет), дублирование, удаление (с подтверждением и выводом количества позиций).
2. **Индикации**
   - В шапке отображать имя активного портфеля, статус (например, "13 позиций", "кредит лимит 40%").
   - В списках/таблицах явно помечать портфель, если показываются данные нескольких (например, в глобальных поисках).
3. **PortfolioSummary**
   - Перевести все селекторы/стейт на активный портфель.
   - Хранить manage-параметры (deposit, risk limit) на уровне портфеля.
4. **UnifiedPositionsTable / SpreadTable**
   - Передавать `portfolioId` в каждую операцию; обновить контекст меню.
   - Убедиться, что фильтры "Show closed" и др. независимо настроены для каждого портфеля (лишние перезаписи убрать).
5. **TopBarBackupButtons & Help**
   - Обновить тексты, чтобы отражали много портфелей; добавить действия "Export active", "Export all".

### Фаза 4 — интеграции и сценарии
1. **Add Position / Add Spread**
   - Форма должна записывать в активный портфель. Возможность выбрать другой (например, при импорте CSV).
2. **IF Rules, Alerts**
   - Все правила/алерты хранятся на портфель.
3. **Сценарный анализ, пресеты фильтров**
   - Персонализировать под портфель (ключи с `portfolioId`).
4. **Маркет-контекст и внешние сервисы**
   - Убедиться, что брокерские ключи/лимиты, если будут, также разделяемы.

### Фаза 5 — миграция UI и стабилизация
1. **Feature flag**
   - Ввести флаг `multiPortfolioEnabled` для поэтапного включения.
2. **Поэтапное тестирование**
   - Юнит: селекторы, действия стора.
   - Интеграционные: \`PortfolioSummary\`, \`UnifiedPositionsTable\`, импорт/экспорт.
   - Regression checklist: переключение портфелей, закрытие позиций, добавление из Add Position.
3. **Документация и обучение**
   - Обновить README/HelpModal: что такое портфель, как переключаться, FAQ.
4. **Обратная совместимость**
   - Проверить старые бэкапы: импорт -> создаёт 1 портфель.
   - Подготовить скрипт/гайд по массовому разделению текущих позиций на несколько портфелей (например, экспорт → ручное редактирование → импорт нескольких портфелей).

### Опциональные улучшения после MVP
- Теги/цветовые ярлыки портфелей и быстрые фильтры по ним в глобальном поиске.
- Совместное отображение сводки по всем портфелям ("Total Exposure" экран).
- Синхронизация настроек портфеля (лимиты, пресеты) между устройствами через облачные бэкапы.
- API для автоматического создания портфелей и закачки позиций скриптами.

### Оценка рисков
- **Сложность миграции**: необходимо двойное тестирование состояния persist + legacy бэкапов.
- **Увелечение объёма памяти**: при большом количестве портфелей требуется lazy-инициализация/выгрузка.
- **UX перегруз**: важно предоставить быстрые CTA и понятные названия, иначе пользователи потеряются.
- **Конкуренция за данные**: переключение портфеля во время открытого модала (View/Edit) может привести к несогласованности — нужны блокировки/предупреждения.

### Следующие шаги
1. Подготовить RFC/документ дизайна на основе данного плана и согласовать с командой.
2. Оценить трудозатраты по фазам, определить приоритеты (например, сначала только переключение/создание без клонов).
3. Завести трекер задач (тикеты) по фазам и распределить между участниками.
