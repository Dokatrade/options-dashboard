# Screenshot Automation Plan

## Goal
Создать автономный инструмент `ScreenShotter`, который запускает Playwright, выбирает заданное портфолио, открывает модальные окна View для каждой опционной конструкции и сохраняет скриншоты с понятными именами.

## Ограничения и ожидаемые вводные
- Приложение запускается локально через `npm run dev` (Vite).
- Данные портфеля и конструкций доступны через UI и внутренние сторы (zustand/localStorage).
- Сеть недоступна во время сценария, поэтому все зависимости должны быть установлены заранее.
- Требуется возможность запускать инструмент скриптом без ручного кликанья.

## Основные фазы

### 1. Подготовка проекта ScreenShotter
1. Создать в `ScreenShotter/` собственный `package.json` с Playwright (chromium) в `devDependencies`.
2. Добавить npm-скрипты: `install:pw`, `test:pw` (опционально), `capture`.
3. Сгенерировать Playwright config (`playwright.config.ts`) с базовым URL `http://localhost:5173` и таймаутами, подходящими для загрузки модалки.
4. Обновить `.gitignore`, если нужно, для Playwright-артефактов (`playwright-report`, `test-results`).

### 2. Определение входных параметров
1. Принять ID портфолио и фильтры конструкций через CLI-параметры, например `--portfolio=<id>` и `--constructions=<comma-separated list>`.
2. Предусмотреть флаг `--headful` для визуальной отладки и `--out-dir=<path>` для явного пути сохранения PNG.
3. Продумать поведение по умолчанию (например, если не передан список конструкций — снимать все).

### 3. Запуск приложения и подготовка данных
1. В инструкции указать, что перед запуском необходимо поднять `npm run dev` в корневом проекте.
2. Скрипт Playwright проверяет доступность `http://localhost:5173` (ожидание до 30 секунд).
3. При необходимости загрузить в localStorage нужные данные портфолио (через `page.goto` и `page.evaluate`).
4. Если есть резервные копии через `TopBarBackupButtons`, предусмотреть utility, который импортирует нужный `Backup` JSON перед первой модалкой.

### 4. Переход к нужному портфолио
1. Изучить DOM главной страницы и найти элементы таблицы портфолио.
2. Реализовать функцию `selectPortfolio(page, portfolioId)`:
   - Ожидать рендера `PortfolioSummary`.
   - Искать строку с нужным ID или именем.
   - Кликать по кнопке, которая открывает список конструкций.
3. Добавить таймауты/ожидания (`page.waitForSelector`) с fallback-логами, если элемент не найден.

### 5. Снятие скриншотов модалок
1. Реализовать `openConstructionView(page, constructionId)`:
   - Нажать `View` в нужной строке.
   - Дождаться появления `PositionView` (селектор на корневом div модалки).
2. Перед скриншотом:
   - Убедиться, что график TradingView не мешает (например, дождаться загрузки iframe или скрыть его через `page.evaluate`).
   - Проставить нужные параметры (rate/volatility), если они зависят от входных аргументов.
3. Использовать `page.screenshot({ path, fullPage: false, clip })`, чтобы захватить только модалку (через `boundingBox`).
4. Закрывать модалку (клик по `Close`) и переходить к следующей конструкции.

### 6. Структура результатов
1. Формат имени файла: `<portfolioId>__<constructionName>__<timestamp>.png`.
2. Если каталог вывода отсутствует — создавать.
3. Логировать каждое сохранение (stdout), чтобы можно было быстро свериться.

### 7. Обработка ошибок и повторов
1. Добавить try/catch вокруг каждой конструкции; в случае ошибки писать отдельный лог и продолжать.
2. Предусмотреть флаг `--halt-on-error`, который останавливает выполнение при первой неудаче.
3. Добавить финальный свод: количество успешных/неуспешных скриншотов.

### 8. Автоматизация и интеграция
1. По желанию добавить GitHub Actions workflow для регрессионных скриншотов (при условии, что сервер можно поднять в CI).
2. Продумать интеграцию с cron/CI локально (например, `npm run dev` в фоне + `ScreenShotter npm run capture`).
3. Опционально: сохранять журналы в JSON (массив объектов с путём к файлу, временем, параметрами запуска).

### 9. Документация
1. В `ScreenShotter/README.md` описать:
   - Требования (Node, npm).
   - Установку (`npm install`, `npx playwright install`).
   - Как запускать dev-сервер и скрипт.
   - Примеры команд.
2. Обновить общий `Options-Dashboard.md` (если требуется) кратким упоминанием инструмента.

### 10. Возможные расширения
- Добавить CLI-режим для пакетной обработки нескольких портфолио (csv/json).
- Экспорт метаданных (описание конструкции, дата экспирации) вместе с PNG (например, рядом JSON или в EXIF).
- Использовать `toMatchSnapshot` Playwright для визуальных тестов.
- Интегрировать с Slack/Email для автоматического уведомления о готовности скриншотов.

## Контроль качества
- Протестировать на портфолио с разным числом конструкций.
- Проверить обработку случаев, где модалка не открывается (например, конструкция пустая).
- Убедиться, что при headless-режиме скриншоты совпадают с headful (минимальные расхождения).
- Настроить автоматически обновляемую дату/время на скриншоте (опционально) или использовать номинальный timestamp в имени файла.

## Возможные шаги дальше:

  1. Инициализировать package.json и установить Playwright согласно плану.
  2. Реализовать CLI-скрипт capture, следуя расписанным фазам.